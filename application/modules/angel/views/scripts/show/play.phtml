<script type="text/javascript" src="<?php echo $this->jsPath('player.js'); ?>"></script>
<script type="text/javascript" src="<?php echo $this->jsPath('qrcode.js'); ?>"></script>
<script type="text/javascript" src="<?php echo $this->jsPath('comment.js'); ?>"></script>

<?php
$player_mode = "video";
$user = false;
if ($this->me) {
    $user = $this->me->getUser();
    if ($user->attribute && $user->attribute['player_mode']) {
        $player_mode = $user->attribute['player_mode'];
    }
}
$bean = $this->resource;
$programs = $bean['programs'];
?>

<?php if (!$user): ?>
    <div class="unlogin-bd">
        <a href="<?php echo $this->login_goto_url ?>" class="btn">立即登录</a>
        <a href="<?php echo $this->register_goto_url ?>" class="btn btn-warning">注册吧</a>
    </div>
<?php endif; ?>

<?php if ($user): ?>
    <script>
        var ts_user_id = '<?php echo $user->id ?>';
    </script>
<?php endif; ?>
<div id="tv-main-container" class="layer">
    <div id='tv-sider'>
        <div class="pxt">
            <button id='btn-refresh' class='ico tv-side-btn'></button>
            <button id='btn-list' class='ico tv-side-btn'></button>
            <?php if ($user): ?>
                <?php if ($player_mode == 'video'): ?>
                    <button id='btn-toggle-audio' rel="audio" class='ico tv-side-btn'></button>
                <?php else: ?>
                    <button id='btn-toggle-video' rel="video" class='ico tv-side-btn'></button>
                <?php endif; ?>
            <?php else: ?>
                <button id='btn-toggle-audio-disabled' rel="audio" class='ico tv-side-btn'></button>
            <?php endif; ?>
        </div>
    </div>

    <div id="m-title">
        <p class="a"><?php echo $this->cur_program['name'] ?></p>
        <p class="b"></p>
    </div>

    <?php if ($user && $user->author): ?>
        <div class="tv-search-content">
            <div class="tv-search-content-head">
                <span class="kw">关键词</span> 找到 <span class="ct">0</span> 条记录
                <span class="close">&times;</span>
            </div>
            <div class="tv-search-content-result">
            </div>
        </div>
    <?php endif; ?>
    <div id="tv-danmubar">
        <div id="tv-danmubar-switch">
            <button class="tv-danmu-btn" id="tv-danmuopened" type="button"><span class="ico"></span><span class="text">弹幕开</span></button>
            <button class="tv-danmu-btn" id="tv-danmuclosed" type="button"><span class="ico"></span><span class="text">弹幕关</span></button>
        </div>
        <div id="tv-danmubar-auto">
            <div id="tv-danmubar-auto-box" style="display: none;">
                <!--<div class="tv-danmubar-single-itm" style="top:80px">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几节目不错， 为随便说说为的看法，首先。为随便说说为的看法。
                    </div>
                    <div class="li opera">
                        43
                    </div>
                    <div class="clear"></div>
                </div>

                <div class="tv-danmubar-single-itm" style="top:180px">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几节目不错， 为随便说说为的看法，首先。。。
                    </div>
                    <div class="li opera selected">
                        0
                    </div>
                    <div class="clear"></div>
                </div>

                <div class="tv-danmubar-single-itm" style="top:280px">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几
                    </div>
                    <div class="li opera">
                        1
                    </div>
                    <div class="clear"></div>
            </div>-->
            </div>
            <button class="ico" id="tv-danmu-all" type="button" style="display: none;"></button>
            <button class="tv-danmu-btn" id="tv-senddanmu" onclick="$.popup({containerBoxSelector: '#tv', content: $('.send-danmu-board').clone(true), width: 400});
                    $('.send-danmu-board .txt').focus();" type="button"><span class="ico"></span>打一发</button>

            <button class="tv-danmu-btn selected" title="弹幕满天飞" id="tv-fullscreendanmu" type="button"><span class="ico"></span></button>
            <button class="tv-danmu-btn" title="精华弹幕" id="tv-verticaldanmu" type="button"><span class="ico"></span></button>
        </div>
        <div id="tv-danmubar-history" style="display: none;">
            <div class="tv-danmubar-history-head">
                <span>所有弹幕</span>
                <button type="button" class="close"></button>
            </div>
            <div class="tv-danmubar-history-body">
                <div class="tv-danmubar-single-itm">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几
                    </div>
                    <div class="li opera">
                        1
                    </div>
                    <div class="clear"></div>
                </div>

                <div class="tv-danmubar-single-itm">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几
                    </div>
                    <div class="li opera">
                        1
                    </div>
                    <div class="clear"></div>
                </div>

                <div class="tv-danmubar-single-itm">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几
                    </div>
                    <div class="li opera">
                        1
                    </div>
                    <div class="clear"></div>
                </div>

                <div class="tv-danmubar-single-itm">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几
                    </div>
                    <div class="li opera">
                        1
                    </div>
                    <div class="clear"></div>
                </div>

                <div class="tv-danmubar-single-itm">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几
                    </div>
                    <div class="li opera">
                        1
                    </div>
                    <div class="clear"></div>
                </div>
                <div class="tv-danmubar-single-itm">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几
                    </div>
                    <div class="li opera">
                        1
                    </div>
                    <div class="clear"></div>
                </div>
                <div class="tv-danmubar-single-itm">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几
                    </div>
                    <div class="li opera">
                        1
                    </div>
                    <div class="clear"></div>
                </div>
                <div class="tv-danmubar-single-itm">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几
                    </div>
                    <div class="li opera">
                        1
                    </div>
                    <div class="clear"></div>
                </div>

                <div class="tv-danmubar-single-itm">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几
                    </div>
                    <div class="li opera">
                        1
                    </div>
                    <div class="clear"></div>
                </div>

                <div class="tv-danmubar-single-itm">
                    <div class="li simple">
                        <span class="danmu-type"></span>
                        <span class="creator">night knight</span>
                        <div class="clear"></div>
                    </div>
                    <div class="li txt-content">
                        这几
                    </div>
                    <div class="li opera">
                        1
                    </div>
                    <div class="clear"></div>
                </div>
            </div>
            <div class="tv-danmubar-history-footer">

            </div>
        </div>
    </div>
    <div id="tv-listbar" sid="<?php echo $bean['id'] ?>">

        <div class="tv-tab-content">
            <div class="tv-tab-content-head">
                <div class="alt alt-list">
                    <img class="alt-img" src="<?php echo $bean['photo'] ?>"/>
                    <div class="alt-title">
                        <p class="t1"><?php echo $bean['name'] ?></p>
                        <div class="t2">by <?php echo $bean['author'] ?></div>
                    </div>
                    <div class="alt-opera">
                        <?php if ($user): ?>
                            <button class="ico" id="add-to-favor"></button>
                        <?php endif; ?>
                    </div>
                </div>
                <div class="alt alt-favor hidden">
                    <div class="alt-title">
                        <p class="t1">我的收藏夹</p>
                        <div class="t2">已收藏 <span></span> 个专辑</div>
                    </div>
                </div>
                <div class="alt alt-hobby hidden">
                    <div class="alt-title">
                        <p class="t1">设置兴趣</p>
                        <div class="t2">根据您的兴趣推送节目</div>
                    </div>
                </div>
                <div class="clear"></div>
            </div>
            <div class="tv-tab-content-body">
                <div class="alt alt-list">
                    <?php foreach ($programs as $program): ?>
                        <?php
                        $cls = "";
                        if ($this->cur_program['id'] == $program['id']) {
                            $cls = " selected";
                        }
                        ?>
                        <div class="list-item clearfix<?php echo $cls ?>" id="<?php echo $program['id'] ?>">
                            <div class="list-item-cell lt"><?php echo $program['name'] ?></div>
                            <div class="list-item-cell rt sharing ico"></div>
                            <div class="list-item-cell rt duration" time="<?php echo $program['time'] ?>"></div>
                        </div>
                    <?php endforeach; ?>
                </div>


                <?php if ($user): ?>
                    <div class="alt alt-favor hidden">

                    </div>
                    <div class="alt alt-hobby hidden">

                    </div>
                <?php endif; ?>
            </div>
        </div>
        <div class="tv-tab-list">
            <ul>
                <li id="list" loaded="true" class="tv-tab-list-item selected">
                    <span>专辑播放列表</span>
                </li>
                <?php if ($user): ?>
                    <li id="favor" class="tv-tab-list-item">
                        <span>我的收藏夹</span>
                    </li>
                    <li id="hobby" class="tv-tab-list-item">
                        <span>兴趣设置</span>
                    </li>
                <?php else: ?>
                    <li class="tv-tab-list-item-disabled">
                        <span>我的收藏夹</span>
                    </li>
                    <li class="tv-tab-list-item-disabled">
                        <span>兴趣设置</span>
                    </li>
                <?php endif; ?>
            </ul>
            <?php if ($user): ?>
                <div class="logout-btn-content">
                    <p>
                        Hey, <?php echo $user->name ? $user->name : $user->username ?>
                        <?php if ($user && $user->author): ?>
                            <span class="vip-badge">达</span>
                        <?php endif; ?>
                    </p>
                    <button class="btn btn-gray btn-sm" id="logout-btn">安全退出</button>
                </div>

            <?php endif; ?>
            <div class="app-down-content">
                <button class="app-down-button" type="button">下载移动端APP</button>
            </div>
            <?php if ($user && $user->author): ?>
                <div class="search-btn-content clearfix">
                    <input type="text" placeholder="搜索 专辑/作者" id="search-txt"/>
                    <button class="btn btn-sm" id="search-btn"></button>
                </div>
            <?php endif; ?>
        </div>
        <button id="tv-tab-close"><i class="ico"></i></button>
    </div>

    <?php if ($player_mode == 'video'): ?>
        <div id="tv-screen" class="layer text-center">
            <video id="tv-video-player" class="player" src="<?php echo $this->cur_program['oss_video'] ?>" preload autoplay="autoplay" oncontextmenu="return false;">
            </video>
            <div id="danmakuwrap" class="danmakuwrap"></div>
            <div id="img_danmu_box" style="width: 100%;height: 100%;position: absolute;top: 0;left: 0;"></div>
        </div>
    <?php else: ?>
        <div id="tv-disk">
            <div id="tv-disk-page" style="background-image:url(<?php echo $bean['photo_main'] ?>)"></div>
        </div>
        <audio id="tv-video-player" src="<?php echo $this->cur_program['oss_audio'] ?>" preload autoplay="autoplay"></audio>
    <?php endif; ?>

    <div id="tv-ctrl-block">
        <div id="tv-ctrl-c">
            <span id="tv-ctrl-st">00:00</span>
            <span id="tv-ctrl-ct">00:00</span>
            <div id="tv-ctrl-prog">
            </div>
        </div>
        <div id="tv-ctrl-play" class="tv-ctrl-s">
            <i class="ico"></i>
        </div>
        <div id="tv-ctrl-pause" class="tv-ctrl-s">
            <i class="ico"></i>
        </div>
        <div id="tv-ctrl-fullscreen" full='no' class="tv-ctrl-s">
            <i class="ico"></i>
        </div>
    </div>

</div>

<div class="P_tmp">
    <div class="send-danmu-board">
        <div>
            <iframe style="display:none" id="ts_uploadpic_iframe" name="ts_uploadpic_iframe"></iframe>
            
            <form class="img_upload_form" style="position:relative;"  name="danmu" encType="multipart/form-data"   method="post" target="ts_uploadpic_iframe" action="/api/comments/image">
                <input type="hidden" name="time_at" class="danmu_time"/>
                <input type="hidden" name="pid" class="danmu_pid"/>
                <input type="hidden" name="type" class="danmu_type" value="image"/>
                <p>写弹幕：</p>
            <input class="txt value_comment" type="text" name="text" maxlength="140" />
            <br/>
            <?php if ($user && $user->author): ?>
            <div id="divPreview" style="line-height:1px;">  
                    <img id="imgHeadPhoto" class="imgHeadPhoto" src=""   alt=""  style="max-width: 340px;max-height: 340px;"/>  
              </div>  
            <span style="display:block;padding: 10px 0;">弹幕配图(可选)</span><input type="file" style="margin-bottom:10px;" class="danmu_img" name="image" onchange="PreviewImage(this,'imgHeadPhoto','divPreview')" size="20"/>
            <?php endif;?>
            <button class="btn submit_comment" type="button">发送</button>
            </form>
        </div>
    </div>

    <div class="list-item clearfix favor-item">
        <div class="list-item-cell lt"></div>
        <div class="list-item-cell rt sharing ico"></div>
        <div class="list-item-cell rt remove-favor ico"></div>
    </div>

    <div class="download-board">
        <ul class="download-board-ul">
            <li>
                <p>IOS App</p>
                <div class="download-board-qr-ios">

                </div>
            </li>
            <li>
                <p>安卓 App</p>
                <div class="download-board-qr-android">

                </div>
            </li>
        </ul>
    </div>

    <div class="unit-item hobby-item">
        <p></p>
    </div>

    <div class="sharing-popup">
        <button class="btn btn-sm hide-qrcode">&lt; 返回</button>
        <div class="ctss">
            <div class="cts-1">
                <p>
                    分享 <span></span>
                </p>
                <a class="sharing-ico weixin" href="javascript:void(0)"><i></i> 微信扫一扫</a>
                <div class="clear"></div>
                <a class="sharing-ico weibo" href="#"><i></i> 分享到新浪微博</a>
                <div class="clear"></div>
                <a class="sharing-ico qqweibo" href="#"><i></i> 分享到腾讯微博</a>
                <div class="clear"></div>
            </div>
            <div class="cts-2">
                <div class="qr"></div>
            </div>
        </div>
    </div>

    <?php echo $this->partial('show/partials/_login_tip.phtml', array('login_url' => $this->login_goto_url, 'register_url' => $this->register_goto_url)); ?>

</div>
    



<!--<button id="seeking-testing-btn" style="position:fixed;z-index:100;bottom:100px;left:100px;padding:10px;">SEEKING BTN</button>-->

<script type="text/javascript">
//    setInterval(function(){
//        location.reload();
//    }, 2000);

    var init_player_mode = '<?php echo $player_mode; ?>';
    var PLAYER = document.getElementsByTagName(init_player_mode)[0];
    $('document').ready(function() {
        // set interval per second
        setInterval(function() {
            $('#tv-ctrl-prog').css('width', (PLAYER.currentTime / PLAYER.duration) * 100 + '%');
            if (!isNaN(PLAYER.duration) && !isNaN(PLAYER.currentTime)) {
                $('#tv-ctrl-st').html(PLAYER.duration.timeFormat());
                $('#tv-ctrl-ct').html(PLAYER.currentTime.timeFormat());
            }
        }, 100);

        $('#tv-ctrl-fullscreen').click(function() {
            switchFullscreen();
        });
        // 防止进入页面连点导致的问题
        setTimeout(function() {
            $('#tv-ctrl-c').click(function() {
                clickSeek($('#tv-ctrl-c'));
                $('#tv-ctrl-play').hide();
                $('#tv-ctrl-pause').show();
            });
        }, 1500);

        $('#btn-list').click(function() {
            $('#tv-listbar').toggle();
            $(this).toggleClass('selected');
        });

        $('#tv-tab-close').click(function() {
            $('#btn-list').click();
        });

        $('#logout-btn').click(function() {
            $.confirm({
                msg: '确定登出吗？',
                confirmCallback: function() {
                    location.href = "<?php echo $this->url(array(), 'logout') ?>";
                },
                containerBoxSelector: '#tv'
            });
        });

        $(PLAYER).on('ended', function() {
<?php if ($user): ?>
                // next program
                var current = $('.tv-tab-content-body .list-item.selected');
                if (current.length) {
                    var next = current.next();

                    if (next.length) {
                        location.href = generatePlayLink($('#tv-listbar').attr('sid'), next.attr('id'), 2);
                    } else {
                        location.href = PLAY_PAGE_URL;
                    }
                }
<?php else: ?>
                // login alert
                loginTipFunc();
<?php endif; ?>

        });

        $.each($('.duration'), function() {
            var $this = $(this);
            var time = parseInt($this.attr('time'));
            var timeStr = time.timeFormat();
            $this.html(timeStr);
        });

        if ($('#add-to-favor').length) {
            $.ajax({
                url: '<?php echo $this->url(array(), 'api-favourite-is') ?>',
                dataType: 'json',
                type: 'post',
                data: {sid: $('#tv-listbar').attr('sid')},
                success: function(response) {
                    if (response.code === 200) {
                        $('#add-to-favor').addClass('selected');
                    }
                }
            });
        }
    });

    // 网速失速
    $('#player').on('stalled', function() {
        console.log('stalled');
        var new_one = $('#player').clone(true);
        $('#player').after(new_one).remove();
    });
    // 网速错误
    $('#player').on('error', function() {
        console.log('error');
        var new_one = $('#player').clone(true);
        $('#player').after(new_one).remove();
    });
    var list = [
        {htmlObject: $('#tv-sider')},
        {htmlObject: $('#tv-ctrl-block')}
    ];
    $('#tv-sider, #tv-ctrl-block, #tv-listbar').mouseenter(function() {
        $.autoToggleListStop();
    });
    $('#tv-sider, #tv-ctrl-block, #tv-listbar').mouseleave(function() {
        $.autoToggleListRestart();
    });
    $.autoToggleList(list);

    $('#tv-ctrl-play').click(function() {
        PLAYER.play();
        $('#tv-ctrl-play').toggle();
        $('#tv-ctrl-pause').toggle();
    });
    $('#tv-ctrl-pause').click(function() {
        PLAYER.pause();
        $('#tv-ctrl-play').toggle();
        $('#tv-ctrl-pause').toggle();
    });

    $('.alt-list .list-item').click(function() {
<?php if ($user): ?>
            var programId = $(this).closest('.list-item').attr('id');
            var specialId = $('#tv-listbar').attr('sid');
            var url = generatePlayLink(specialId, programId, 2);
            location.href = url;
<?php else: ?>
            loginTipFunc();
<?php endif; ?>
    });

    $('.alt-list .list-item .sharing').click(function() {
        return sharingIt($(this));
    });
<?php if ($user): ?>
        $('.tv-tab-list-item').click(function() {
            // 翻页
            var $this = $(this).closest('.tv-tab-list-item');
            if ($this.hasClass('.selected')) {
                return;
            }
            $('.tv-tab-list-item').removeClass('selected');
            $this.addClass('selected');
            var id = $this.attr('id');
            $('.alt').addClass('hidden');
            $('.alt-' + id).removeClass('hidden');

            if ($this.attr('loaded') !== 'true') {
                $.waiting("读取中 ...");
                switch (id) {
                    case 'list':
                        break;
                    case 'favor':
                        var url = '<?php echo $this->url(array(), 'api-favourite-list') ?>';
                        $.ajax({
                            url: url,
                            dataType: 'json',
                            type: 'get',
                            success: function(response) {
                                if (response.code === 200) {
                                    var body = $('.tv-tab-content-body .alt-favor');
                                    body.empty();
                                    var header = $('.tv-tab-content-head .alt-favor');
                                    header.find('.t2 span').html('0');
                                    if (response.data && response.data.specials && response.data.specials.length) {

                                        header.find('.t2 span').html(response.data.specials.length);

                                        $.each(response.data.specials, function() {
                                            var html = $('.P_tmp .favor-item').clone(true);
                                            html.attr('sid', this.id).find('.list-item-cell.lt').html(this.name);
                                            html.attr('sharing_photo', this.sharing_photo);
                                            html.find('.remove-favor').click(function() {
                                                var $this = $(this);
                                                var sid = $this.closest('.list-item').attr('sid');
                                                removeFavor(sid, function() {
                                                    $('.list-item[sid="' + sid + '"]').remove();
                                                    if (sid === $('#tv-listbar').attr('sid')) {
                                                        $('#add-to-favor').removeClass('selected');
                                                    }
                                                    var ci = parseInt(header.find('.t2 span').html());
                                                    if (ci) {
                                                        header.find('.t2 span').html(ci - 1);
                                                    }
                                                });
                                                return false;
                                            });
                                            html.find('.sharing').click(function() {
                                                return sharingIt($(this));
                                            });
                                            html.click(function() {
                                                var $this = $(this).closest('.list-item');
                                                var sid = $this.attr('sid');
                                                location.href = generatePlayLink(sid, false, 2);
                                            });
                                            body.append(html);
                                        });

                                        $this.attr('loaded', 'true');
                                    }
                                }
                                $.endWaiting();
                            }
                        });
                        break;
                    case 'hobby':
                        var url = '<?php echo $this->url(array(), 'api-user-category-list') ?>';
                        $.ajax({
                            url: url,
                            dataType: 'json',
                            type: 'post',
                            success: function(response) {
                                if (response.code === 200) {
                                    var body = $('.tv-tab-content-body .alt-hobby');
                                    body.empty();
                                    if (response.data && response.data && response.data.length) {
                                        body.append($('<div>').addClass('unit-items'));
                                        $.each(response.data, function() {
                                            var html = $('.P_tmp .hobby-item').clone(true);
                                            html.attr('cid', this.id).find('p').html(this.name);
                                            html.click(function() {
                                                $(this).closest('.unit-item').toggleClass('selected');
                                                var arr = new Array();
                                                var categories = 'none';
                                                if ($('.unit-item.selected').length) {
                                                    $.each($('.unit-item.selected'), function() {
                                                        var $this = $(this).closest('.unit-item');
                                                        arr.push($this.attr('cid'));
                                                    });
                                                    categories = arr.join(';');
                                                }
    <?php if ($user): ?>
                                                    var data = {
                                                        uid: '<?php echo $user->id ?>',
                                                        category: categories
                                                    };
                                                    $.waiting(null, $('#tv'));
                                                    $.ajax({
                                                        url: '<?php echo $this->url(array(), 'api-user-category-save') ?>',
                                                        dataType: 'json',
                                                        type: 'post',
                                                        data: data,
                                                        complete: function() {
                                                            $.endWaiting();
                                                        }
                                                    });
    <?php endif ?>
                                            });
                                            if (this.like) {
                                                html.addClass('selected');
                                            }
                                            body.find('.unit-items').append(html);
                                        });
                                        $this.attr('loaded', 'true');
                                    }
                                }
                                $.endWaiting();
                            }
                        });
                        break;
                }
            }
        });
<?php else: ?>
        $('.tv-tab-list-item-disabled').click(function() {
            loginTipFunc();
        });
<?php endif; ?>


    $('#add-to-favor').click(function() {
        var $this = $(this);
        var sid = $('#tv-listbar').attr('sid');
        if ($this.hasClass('selected')) {
            // remove
            removeFavor(sid, function() {
                $('#favor').attr('loaded', 'false');
                $('#add-to-favor').removeClass('selected');
            });
        } else {
            // add
            $.ajax({
                url: '<?php echo $this->url(array(), 'api-favourite-add') ?>',
                data: {sid: sid},
                type: 'post',
                dataType: 'json',
                success: function(response) {
                    if (response.code === 200) {
                        $this.addClass('selected');
                        $('#favor').attr('loaded', 'false');
                    }
                }
            });
        }
    });
<?php if ($user): ?>
        $('#btn-toggle-audio, #btn-toggle-video').click(function() {
            var mode = $(this).attr('rel');
            switchMode(mode);
            var bean = $('#tv-listbar').attr('sid') + ';' + $('.tv-tab-content-body .list-item.selected').attr('id') + ';' + PLAYER.currentTime;
            localStorage.setItem('switch-mode', bean);
        });
<?php else: ?>
        $('#btn-toggle-audio-disabled').click(function() {
            loginTipFunc();
        });
<?php endif; ?>
    $(document).ready(function() {
        setTimeout(function() {
            $('#m-title').css('opacity', '0.15');
        }, 3000);

        var ls = localStorage.getItem('switch-mode');
        if (ls) {
            var lss = ls.split(';');
            if (lss[0] === $('#tv-listbar').attr('sid') && lss[1] === $('.tv-tab-content-body .list-item.selected').attr('id')) {
                seek(null, parseFloat(lss[2]));
                localStorage.setItem('switch-mode', null);
            }
        }

        initDownloadQr(QRCode, '<?php echo $this->mobile_download_link_ios ?>', '<?php echo $this->mobile_download_link_android ?>');
    });

    $('.hide-qrcode').click(function() {
        var container = $(this).hide().closest('.sharing-popup');
        container.find('.cts-2').animate({
            left: '100%'
        }, 200, 'linear');
    });

    function switchMode(mode) {
        var data = {'value': mode};
        var url = "<?php echo $this->url(array(), 'user-player-mode') ?>";

        $.ajax({
            url: url,
            data: data,
            dataType: 'json',
            method: 'post',
            success: function(response) {
                if (response.code === 200) {
                    location.reload();
                } else {
                }
            },
            error: function() {
            }
        });
    }

    function removeFavor(sid, callback) {
        $.confirm({
            msg: '确定移除该项收藏吗？',
            confirmCallback: function() {
                $.ajax({
                    url: '<?php echo $this->url(array(), 'api-favourite-remove') ?>',
                    data: {sid: sid},
                    type: 'post',
                    dataType: 'json',
                    success: function(response) {
                        if (response.code === 200) {
                            if (typeof callback === 'function')
                                callback();
                        }
                    }
                });
            },
            containerBoxSelector: '#tv'
        });
    }

<?php if ($user && $user->author): ?>
        $('.tv-search-content-head .close').click(function() {
            var $this = $(this);
            var container = $this.closest('.tv-search-content');
            container.slideUp(300);
        });
        $('#search-btn').click(function() {
            var q = $.trim($('#search-txt').val());
            if (!q) {
                $.alertbox({msg: "搜索文字为空，请输入你希望搜索的文字。"});
                return;
            }
            $.waiting();
            $.ajax({
                url: '<?php echo $this->url(array(), 'api-search-home') ?>?q=' + q,
                dataType: 'json',
                type: 'get',
                success: function(response) {
                    if (response.code === 200) {
                        // success
                        var data = response.data;
                        $('.tv-search-content-result').empty();
                        $.each(data, function() {
                            var sid = this.id;
                            var name = this.name;
                            var a = $('<a>').addClass('search-itm').attr('href', generatePlayLink(sid, null, 2));
                            a.html(name);
                            $('.tv-search-content-result').append(a);
                        });
                        $('.tv-search-content-head .kw').html(q);
                        $('.tv-search-content-head .ct').html(data.length);
                    } else if (response.code === 404) {
                        // no result
                        $('.tv-search-content-result').html('<p class="pad-20 text-center">未搜索到相关记录</p>');
                        $('.tv-search-content-head .kw').html(q);
                        $('.tv-search-content-head .ct').html(0);
                    } else {
                        // error
                        $('.tv-search-content-result').html('<p class="pad-20 text-center">网络错误，请重试</p>');
                        $('.tv-search-content-head .kw').html(q);
                        $('.tv-search-content-head .ct').html(0);
                    }
                },
                complete: function() {
                    $.endWaiting();
                    $('.tv-search-content').slideDown(300);
                }
            });
        });
<?php endif; ?>

<?php if ($user): ?>
        $('#btn-refresh').click(function() {
            $.waiting('正在为您推送新专辑...');
            setTimeout(function() {
                location.href = PLAY_PAGE_URL;
            }, 3000);
        });
<?php else: ?>
        $('#btn-refresh').click(function() {
            loginTipFunc();
        });
<?php endif; ?>

<?php if ($player_mode == 'audio'): ?>
        // rotate the disk
        var __DURATION = 20000;
        var __CHECKINGDISK = 10;
        $(document).ready(function() {
            $(PLAYER).on('play', function() {
                $.rotateDiv(false, '#tv-disk-page', __DURATION);
                var disk_rotate_interval = setInterval(function() {
                    $.rotateDiv(false, '#tv-disk-page', __DURATION);
                }, __DURATION);
                $('body').data('disk_rotate_interval', disk_rotate_interval);
            });

            $(PLAYER).on('pause', function() {
                var disk_rotate_interval = $('body').data('disk_rotate_interval');
                if (disk_rotate_interval) {
                    clearInterval(disk_rotate_interval);
                }
                $('#tv-disk-page').stop(true);
            });
        });
<?php endif; ?>
</script>

